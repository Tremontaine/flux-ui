<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flux Image Generator</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --primary-light: #e0e7ff;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }
        input[type="range"] {
            -webkit-appearance: none;
            height: 0.5rem;
            background: #e5e7eb;
            border-radius: 0.25rem;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            transition: all 0.15s ease;
        }
        input[type="range"]::-webkit-slider-thumb:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
        }
        #notification {
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .param-group {
            transition: all 0.3s ease;
        }
        button:focus {
            outline: 2px solid var(--primary-light);
            outline-offset: 2px;
        }
        button:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <header class="bg-white shadow-sm">
        <div class="container mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center">
                <h1 class="text-2xl font-bold text-indigo-600">Flux Image Generator</h1>
            </div>
            <div id="api-key-container" class="flex items-center">
                <input type="password" id="api-key-input" placeholder="Enter API Key" 
                       class="mr-2 px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button id="save-api-key" class="px-4 py-2 bg-indigo-600 text-white rounded-md text-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    Save Key
                </button>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Parameters Column -->
            <div class="lg:col-span-1 bg-white rounded-lg shadow p-6">
                <h2 class="text-lg font-medium mb-4">Generation Settings</h2>
                
                <!-- Model Selection -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Model</label>
                    <select id="model-selector" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="flux-pro-1.1">Flux Pro 1.1</option>
                        <option value="flux-pro">Flux Pro</option>
                        <option value="flux-dev">Flux Dev</option>
                        <option value="flux-pro-1.1-ultra">Flux Ultra</option>
                    </select>
                </div>
                
                <!-- Prompt -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Prompt</label>
                    <textarea id="prompt-input" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" 
                              placeholder="Describe what you want to generate..."></textarea>
                </div>
                
                <!-- Image Dimensions -->
                <div class="mb-4 param-group" id="dimensions-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Dimensions</label>
                    <select id="dimensions-selector" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="512x512">512 Ã— 512</option>
                        <option value="768x512">768 Ã— 512</option>
                        <option value="512x768">512 Ã— 768</option>
                        <option value="1024x576">1024 Ã— 576</option>
                        <option value="576x1024">576 Ã— 1024</option>
                        <option value="1024x768" selected>1024 Ã— 768</option>
                        <option value="768x1024">768 Ã— 1024</option>
                        <option value="1024x1024">1024 Ã— 1024</option>
                        <option value="1280x720">1280 Ã— 720</option>
                        <option value="720x1280">720 Ã— 1280</option>
                        <option value="1440x768">1440 Ã— 768</option>
                        <option value="768x1440">768 Ã— 1440</option>
                        <option value="1440x1024">1440 Ã— 1024</option>
                        <option value="1024x1440">1024 Ã— 1440</option>
                        <option value="1440x1440">1440 Ã— 1440</option>
                    </select>
                </div>
                
                <!-- Aspect Ratio (for Ultra model) -->
                <div id="aspect-ratio-group" class="mb-4 param-group hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Aspect Ratio</label>
                    <select id="aspect-ratio-selector" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="1:1">1:1 (Square)</option>
                        <option value="4:3">4:3</option>
                        <option value="16:9" selected>16:9</option>
                        <option value="21:9">21:9 (Ultra-wide)</option>
                        <option value="3:4">3:4</option>
                        <option value="9:16">9:16</option>
                        <option value="9:21">9:21</option>
                    </select>
                </div>
                
                <!-- Image Prompt (for remix) -->
                <div id="image-prompt-group" class="mb-4 param-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Image Prompt</label>
                    <div class="flex flex-col space-y-2">
                        <label class="flex items-center justify-center w-full h-20 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer hover:bg-gray-50">
                            <div class="flex flex-col items-center">
                                <p class="text-sm text-gray-500">Click to upload an image</p>
                                <p id="image-prompt-name" class="text-xs text-gray-400 mt-1">No file selected</p>
                            </div>
                            <input id="image-prompt-input" type="file" class="hidden" accept="image/png, image/jpeg, image/jpg" />
                        </label>
                        <div class="hidden" id="image-prompt-strength-container">
                            <label class="block text-xs font-medium text-gray-700 mb-1">Image Strength: <span id="image-prompt-strength-value">0.3</span></label>
                            <input type="range" id="image-prompt-strength" min="0" max="1" step="0.05" value="0.3" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        </div>
                    </div>
                </div>
                
                <!-- Steps -->
                <div class="mb-4 param-group" id="steps-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Steps: <span id="steps-value">40</span></label>
                    <input type="range" id="steps-slider" min="1" max="50" value="40" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>
                
                <!-- Guidance Scale -->
                <div class="mb-4 param-group" id="guidance-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Guidance Scale: <span id="guidance-value">2.5</span></label>
                    <input type="range" id="guidance-slider" min="1.5" max="5" step="0.1" value="2.5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>
                
                <!-- Safety Tolerance -->
                <div class="mb-4 param-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Safety Tolerance: <span id="safety-value">2</span></label>
                    <input type="range" id="safety-slider" min="0" max="6" step="1" value="2" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <p class="text-xs text-gray-500 mt-1">Higher values are less strict (0 = most strict, 6 = least strict)</p>
                </div>
                
                <!-- Seed -->
                <div class="mb-4 param-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Seed</label>
                    <div class="flex">
                        <input type="number" id="seed-input" placeholder="Random" class="w-full px-3 py-2 border border-gray-300 rounded-l-md text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <button id="random-seed-btn" class="px-3 py-2 bg-gray-100 border border-gray-300 border-l-0 rounded-r-md hover:bg-gray-200">
                            ðŸŽ²
                        </button>
                    </div>
                </div>
                
                <!-- Advanced Options -->
                <div class="mb-4">
                    <div class="flex justify-between items-center cursor-pointer" id="advanced-toggle">
                        <span class="text-sm font-medium text-gray-700">Advanced Options</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" id="advanced-icon">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                    
                    <div class="mt-2 hidden" id="advanced-options">
                        <!-- Prompt Upsampling -->
                        <div class="mb-3 param-group" id="prompt-upsampling-group">
                            <div class="flex items-center">
                                <input type="checkbox" id="prompt-upsampling" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                <label for="prompt-upsampling" class="ml-2 block text-sm text-gray-700">Prompt Upsampling</label>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Automatically enhances prompt with additional details</p>
                        </div>
                        
                        <!-- Raw Mode (Ultra only) -->
                        <div class="mb-3 param-group hidden" id="raw-mode-group">
                            <div class="flex items-center">
                                <input type="checkbox" id="raw-mode" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                <label for="raw-mode" class="ml-2 block text-sm text-gray-700">Raw Mode</label>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Generate less processed, more natural-looking images</p>
                        </div>
                        
                        <!-- Interval (Pro only) -->
                        <div class="mb-3 param-group hidden" id="interval-group">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Interval: <span id="interval-value">2.0</span></label>
                            <input type="range" id="interval-slider" min="1" max="4" step="0.1" value="2.0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            <p class="text-xs text-gray-500 mt-1">Parameter for guidance control</p>
                        </div>
                        
                        <!-- Output Format -->
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Output Format</label>
                            <div class="flex space-x-4">
                                <div class="flex items-center">
                                    <input type="radio" id="format-jpeg" name="output-format" value="jpeg" checked class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                                    <label for="format-jpeg" class="ml-2 block text-sm text-gray-700">JPEG</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" id="format-png" name="output-format" value="png" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                                    <label for="format-png" class="ml-2 block text-sm text-gray-700">PNG</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Generate Button -->
                <button id="generate-btn" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    Generate Image
                </button>
            </div>
            
            <!-- Preview Column -->
            <div class="lg:col-span-2 bg-white rounded-lg shadow">
                <div class="p-6 border-b border-gray-200">
                    <h2 class="text-lg font-medium">Preview</h2>
                </div>
                <div class="p-6 flex flex-col items-center justify-center min-h-[500px]" id="preview-container">
                    <div id="generation-placeholder" class="text-center text-gray-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <p>Your generated image will appear here</p>
                    </div>
                    <img id="preview-image" class="max-w-full max-h-[500px] hidden rounded-lg shadow-lg" alt="Generated image">
                    <div id="loading-indicator" class="hidden flex flex-col items-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4"></div>
                        <p class="text-gray-600" id="loading-text">Generating your image...</p>
                    </div>
                </div>
                <div class="px-6 pb-6">
                    <div class="flex flex-wrap justify-center gap-2 mt-4" id="action-buttons">
                        <button id="copy-params-btn" class="px-3 py-1.5 border border-gray-300 bg-white text-gray-600 rounded-md text-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 hidden">
                            Copy Parameters
                        </button>
                        <button id="download-btn" class="px-3 py-1.5 border border-gray-300 bg-white text-gray-600 rounded-md text-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 hidden">
                            Open Image
                        </button>
                        <button id="copy-image-btn" class="px-3 py-1.5 border border-gray-300 bg-white text-gray-600 rounded-md text-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 hidden">
                            Copy Image URL
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-white border-t border-gray-200 py-4 mt-8">
        <div class="container mx-auto px-4 text-center text-sm text-gray-500">
            <p>Flux Image Generator | Simple interface for 
               <a href="https://blackforestlabs.ai/" target="_blank" class="text-indigo-600 hover:text-indigo-800">
                  Black Forest Labs
               </a> 
               Flux API | 
               <a href="https://github.com/Tremontaine/flux-ui" target="_blank" class="text-indigo-600 hover:text-indigo-800">
                  GitHub
               </a>
            </p>
        </div>
    </footer>

    <!-- Notification -->
    <div id="notification" class="fixed right-4 bottom-4 bg-red-500 text-white p-4 rounded-lg shadow-lg transform transition-transform duration-300 translate-y-20 opacity-0">
        <div class="flex items-center">
            <svg id="notification-icon" class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span id="notification-message">Error message goes here</span>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Flux Image Generator loaded');
            
            // Image Prompt Data
            let imagePromptData = null;
            
            // Current Parameters
            let currentParams = {};
            let currentImageUrl = '';
            
            // API Configuration
            const apiConfig = {
                baseUrl: 'https://api.us1.bfl.ai/v1',
                apiKey: ''
            };
            
            // Try to get API key from localStorage
            try {
                const storedKey = localStorage.getItem('flux_api_key');
                if (storedKey) {
                    apiConfig.apiKey = storedKey;
                }
            } catch (e) {
                console.error('Error accessing localStorage:', e);
            }
            
            // DOM Elements
            const elements = {
                // Main controls
                apiKeyInput: document.getElementById('api-key-input'),
                saveApiKeyBtn: document.getElementById('save-api-key'),
                modelSelector: document.getElementById('model-selector'),
                promptInput: document.getElementById('prompt-input'),
                dimensionsSelector: document.getElementById('dimensions-selector'),
                aspectRatioSelector: document.getElementById('aspect-ratio-selector'),
                stepsSlider: document.getElementById('steps-slider'),
                stepsValue: document.getElementById('steps-value'),
                guidanceSlider: document.getElementById('guidance-slider'),
                guidanceValue: document.getElementById('guidance-value'),
                safetySlider: document.getElementById('safety-slider'),
                safetyValue: document.getElementById('safety-value'),
                seedInput: document.getElementById('seed-input'),
                randomSeedBtn: document.getElementById('random-seed-btn'),
                promptUpsampling: document.getElementById('prompt-upsampling'),
                rawMode: document.getElementById('raw-mode'),
                intervalSlider: document.getElementById('interval-slider'),
                intervalValue: document.getElementById('interval-value'),
                formatJpeg: document.getElementById('format-jpeg'),
                formatPng: document.getElementById('format-png'),
                generateBtn: document.getElementById('generate-btn'),
                
                // Image prompt
                imagePromptInput: document.getElementById('image-prompt-input'),
                imagePromptName: document.getElementById('image-prompt-name'),
                imagePromptStrength: document.getElementById('image-prompt-strength'),
                imagePromptStrengthValue: document.getElementById('image-prompt-strength-value'),
                imagePromptStrengthContainer: document.getElementById('image-prompt-strength-container'),
                
                // Groups
                dimensionsGroup: document.getElementById('dimensions-group'),
                aspectRatioGroup: document.getElementById('aspect-ratio-group'),
                stepsGroup: document.getElementById('steps-group'),
                guidanceGroup: document.getElementById('guidance-group'),
                imagePromptGroup: document.getElementById('image-prompt-group'),
                rawModeGroup: document.getElementById('raw-mode-group'),
                intervalGroup: document.getElementById('interval-group'),
                promptUpsamplingGroup: document.getElementById('prompt-upsampling-group'),
                
                // Advanced options
                advancedToggle: document.getElementById('advanced-toggle'),
                advancedOptions: document.getElementById('advanced-options'),
                advancedIcon: document.getElementById('advanced-icon'),
                
                // Preview
                previewContainer: document.getElementById('preview-container'),
                previewImage: document.getElementById('preview-image'),
                generationPlaceholder: document.getElementById('generation-placeholder'),
                loadingIndicator: document.getElementById('loading-indicator'),
                loadingText: document.getElementById('loading-text'),
                
                // Action buttons
                actionButtons: document.getElementById('action-buttons'),
                copyParamsBtn: document.getElementById('copy-params-btn'),
                downloadBtn: document.getElementById('download-btn'),
                copyImageBtn: document.getElementById('copy-image-btn'),
                
                // Notification
                notification: document.getElementById('notification'),
                notificationMessage: document.getElementById('notification-message'),
                notificationIcon: document.getElementById('notification-icon')
            };
            
            // Initialize UI
            if (apiConfig.apiKey) {
                elements.apiKeyInput.value = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
            }
            
            // Event Listeners
            elements.saveApiKeyBtn.addEventListener('click', saveApiKey);
            elements.modelSelector.addEventListener('change', updateModelParams);
            elements.advancedToggle.addEventListener('click', toggleAdvancedOptions);
            elements.randomSeedBtn.addEventListener('click', generateRandomSeed);
            elements.generateBtn.addEventListener('click', generateImage);
            
            // Setup value display for sliders
            setupSlider(elements.stepsSlider, elements.stepsValue);
            setupSlider(elements.guidanceSlider, elements.guidanceValue);
            setupSlider(elements.safetySlider, elements.safetyValue);
            setupSlider(elements.intervalSlider, elements.intervalValue);
            setupSlider(elements.imagePromptStrength, elements.imagePromptStrengthValue);
            
            // Setup image prompt
            elements.imagePromptInput.addEventListener('change', handleImagePromptUpload);
            
            // Setup action buttons
            elements.downloadBtn.addEventListener('click', openImage);
            elements.copyImageBtn.addEventListener('click', copyImageUrl);
            elements.copyParamsBtn.addEventListener('click', copyParams);
            
            // Initialize model parameters
            updateModelParams();
            
            function saveApiKey() {
                try {
                    const apiKey = elements.apiKeyInput.value.trim();
                    if (apiKey && !apiKey.includes('â€¢')) {
                        // Only save if it's not the masked value
                        apiConfig.apiKey = apiKey;
                        localStorage.setItem('flux_api_key', apiKey);
                        elements.apiKeyInput.value = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
                        showNotification('API key saved successfully!', 'success');
                    } else if (apiKey.includes('â€¢')) {
                        // If they try to save the masked value, show a message
                        showNotification('Please enter your actual API key', 'warning');
                    } else {
                        showNotification('Please enter a valid API key', 'error');
                    }
                } catch (error) {
                    console.error('Error saving API key:', error);
                    showNotification('Failed to save API key', 'error');
                }
            }
            
            function updateModelParams() {
                const model = elements.modelSelector.value;
                console.log("Updating parameters for model:", model);
                
                // Reset all model-specific groups
                elements.dimensionsGroup.classList.remove('hidden');
                elements.aspectRatioGroup.classList.add('hidden');
                elements.imagePromptGroup.classList.remove('hidden');
                elements.rawModeGroup.classList.add('hidden');
                elements.intervalGroup.classList.add('hidden');
                elements.promptUpsamplingGroup.classList.remove('hidden');
                elements.stepsGroup.classList.remove('hidden');
                elements.guidanceGroup.classList.remove('hidden');
                
                // Show image prompt strength if there's an image and it's Ultra model
                if (imagePromptData && model === 'flux-pro-1.1-ultra') {
                    elements.imagePromptStrengthContainer.classList.remove('hidden');
                } else {
                    elements.imagePromptStrengthContainer.classList.add('hidden');
                }
                
                // Update slider ranges and visibility based on model
                switch (model) {
                    case 'flux-pro-1.1-ultra':
                        // Ultra model uses aspect ratio instead of dimensions
                        elements.dimensionsGroup.classList.add('hidden');
                        elements.aspectRatioGroup.classList.remove('hidden');
                        elements.rawModeGroup.classList.remove('hidden');
                        // Ultra doesn't use guidance or steps
                        elements.guidanceGroup.classList.add('hidden');
                        elements.stepsGroup.classList.add('hidden');
                        break;
                    
                    case 'flux-pro':
                        // Set Pro specific ranges
                        elements.guidanceSlider.min = "1.5";
                        elements.guidanceSlider.max = "5.0";
                        elements.guidanceSlider.value = "2.5";
                        elements.guidanceValue.textContent = "2.5";
                        elements.stepsSlider.min = "1";
                        elements.stepsSlider.max = "50";
                        elements.stepsSlider.value = "40";
                        elements.stepsValue.textContent = "40";
                        
                        // Make sure interval for Pro is visible
                        elements.intervalGroup.classList.remove('hidden');
                        break;
                    
                    case 'flux-dev':
                        // Set Dev specific ranges
                        elements.guidanceSlider.min = "1.5";
                        elements.guidanceSlider.max = "5.0";
                        elements.guidanceSlider.value = "3.0";
                        elements.guidanceValue.textContent = "3.0";
                        elements.stepsSlider.min = "1";
                        elements.stepsSlider.max = "50";
                        elements.stepsSlider.value = "28";
                        elements.stepsValue.textContent = "28";
                        break;
                    
                    case 'flux-pro-1.1':
                        // Pro 1.1 doesn't use guidance or steps
                        elements.guidanceGroup.classList.add('hidden');
                        elements.stepsGroup.classList.add('hidden');
                        break;
                }
                
                console.log("Updated UI for model:", model);
            }

            function toggleAdvancedOptions() {
                elements.advancedOptions.classList.toggle('hidden');
                const isVisible = !elements.advancedOptions.classList.contains('hidden');
                if (isVisible) {
                    elements.advancedIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />`;
                } else {
                    elements.advancedIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />`;
                }
            }
            
            function setupSlider(slider, valueDisplay) {
                if (slider && valueDisplay) {
                    slider.addEventListener('input', () => {
                        valueDisplay.textContent = slider.value;
                    });
                }
            }
            
            function generateRandomSeed() {
                elements.seedInput.value = Math.floor(Math.random() * 1000000);
            }
            
            function handleImagePromptUpload(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                elements.imagePromptName.textContent = file.name;
                
                // Show image prompt strength control only if model is Ultra
                if (elements.modelSelector.value === 'flux-pro-1.1-ultra') {
                    elements.imagePromptStrengthContainer.classList.remove('hidden');
                } else {
                    elements.imagePromptStrengthContainer.classList.add('hidden');
                }
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    // Store base64 data
                    imagePromptData = event.target.result.split(',')[1];
                    console.log("Image data loaded", imagePromptData ? "successfully" : "failed");
                    
                    // Ensure strength slider is visible for Ultra after image is loaded
                    if (elements.modelSelector.value === 'flux-pro-1.1-ultra') {
                        elements.imagePromptStrengthContainer.classList.remove('hidden');
                    }
                };
                reader.readAsDataURL(file);
            }
            
            function generateImage() {
                console.log('Generate button clicked');
                
                // Check if API key is available
                if (!apiConfig.apiKey) {
                    showNotification('Please enter your API key first', 'error');
                    return;
                }
                
                // Get model type and prepare parameters
                const model = elements.modelSelector.value;
                const params = buildRequestParams(model);
                
                if (!params) {
                    // buildRequestParams will show error notification if needed
                    return;
                }
                
                // Store current parameters for later use
                currentParams = params;
                
                // Show loading state
                toggleLoading(true);
                
                // Make the API request
                makeApiRequest(model, params)
                    .then(response => {
                        console.log("API response:", response);
                        if (response.id) {
                            pollForResult(response.id);
                        } else {
                            throw new Error('No task ID returned from API');
                        }
                    })
                    .catch(error => {
                        console.error('Generation error:', error);
                        showNotification(error.message || 'Failed to generate image', 'error');
                        toggleLoading(false);
                    });
            }
            
            function buildRequestParams(model) {
                // Common parameters for all models
                const params = {
                    safety_tolerance: parseInt(elements.safetySlider.value),
                    output_format: elements.formatJpeg.checked ? 'jpeg' : 'png',
                    prompt_upsampling: elements.promptUpsampling.checked
                };
                
                // Add prompt if not empty
                const prompt = elements.promptInput.value.trim();
                if (prompt) {
                    params.prompt = prompt;
                } else if (model !== 'flux-pro-1.1-ultra') {
                    // Ultra model can work without prompt, others require it
                    showNotification('Please enter a prompt', 'error');
                    return null;
                }
                
                // Add seed if provided
                if (elements.seedInput.value) {
                    params.seed = parseInt(elements.seedInput.value);
                }
                
                // Add image prompt if uploaded
                if (imagePromptData) {
                    params.image_prompt = imagePromptData;
                    
                    // Add image prompt strength for Ultra model
                    if (model === 'flux-pro-1.1-ultra') {
                        params.image_prompt_strength = parseFloat(elements.imagePromptStrength.value);
                    }
                }
                
                // Add model-specific parameters
                switch (model) {
                    case 'flux-pro-1.1-ultra':
                        // Ultra uses aspect ratio instead of dimensions
                        params.aspect_ratio = elements.aspectRatioSelector.value;
                        
                        // Add raw mode if enabled
                        if (elements.rawMode.checked) {
                            params.raw = true;
                        }
                        break;
                        
                    case 'flux-pro-1.1':
                        // Add dimensions
                        const [width, height] = elements.dimensionsSelector.value.split('x').map(Number);
                        params.width = width;
                        params.height = height;
                        break;
                        
                    case 'flux-pro':
                        // Add dimensions
                        const [proWidth, proHeight] = elements.dimensionsSelector.value.split('x').map(Number);
                        params.width = proWidth;
                        params.height = proHeight;
                        
                        // Add Pro-specific parameters
                        params.steps = parseInt(elements.stepsSlider.value);
                        params.guidance = parseFloat(elements.guidanceSlider.value);
                        
                        // Make sure interval is included for Flux Pro
                        params.interval = parseFloat(elements.intervalSlider.value);
                        break;
                        
                    case 'flux-dev':
                        // Add dimensions
                        const [devWidth, devHeight] = elements.dimensionsSelector.value.split('x').map(Number);
                        params.width = devWidth;
                        params.height = devHeight;
                        
                        // Add Dev-specific parameters
                        params.steps = parseInt(elements.stepsSlider.value);
                        params.guidance = parseFloat(elements.guidanceSlider.value);
                        break;
                }
                
                // Debug info to make sure everything is included
                console.log("Final parameters:", params);
                
                return params;
            }            
            async function makeApiRequest(model, params) {
                // Select the correct endpoint based on model
                let endpoint;
                switch (model) {
                    case 'flux-pro-1.1':
                        endpoint = '/flux-pro-1.1';
                        break;
                    case 'flux-pro':
                        endpoint = '/flux-pro';
                        break;
                    case 'flux-dev':
                        endpoint = '/flux-dev';
                        break;
                    case 'flux-pro-1.1-ultra':
                        endpoint = '/flux-pro-1.1-ultra';
                        break;
                    default:
                        throw new Error('Invalid model selected');
                }
                
                console.log(`Making request to ${apiConfig.baseUrl}${endpoint} with params:`, params);
                
                try {
                    const response = await fetch(`${apiConfig.baseUrl}${endpoint}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-key': apiConfig.apiKey
                        },
                        body: JSON.stringify(params)
                    });
                    
                    if (!response.ok) {
                        let errorText = `API error (${response.status})`;
                        try {
                            const errorData = await response.json();
                            errorText = errorData.message || errorData.detail || errorText;
                        } catch (e) {
                            // Can't parse JSON, use default error
                        }
                        throw new Error(errorText);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('API request error:', error);
                    throw error;
                }
            }
            
            function pollForResult(taskId) {
                elements.loadingText.textContent = 'Generating your image...';
                console.log(`Polling for result: ${taskId}`);
                
                const checkResult = async () => {
                    try {
                        const response = await fetch(`${apiConfig.baseUrl}/get_result?id=${taskId}`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                                'x-key': apiConfig.apiKey
                            }
                        });
                        
                        if (!response.ok) {
                            throw new Error(`API error: ${response.status}`);
                        }
                        
                        const result = await response.json();
                        console.log("Poll result:", result);
                        
                        if (result.status === 'Ready' && result.result) {
                            // Generation completed successfully
                            let imageUrl;
                            
                            // Extract the URL from the correct location in the response
                            if (result.result.sample) {
                                imageUrl = result.result.sample;
                            } else if (typeof result.result === 'string') {
                                imageUrl = result.result;
                            } else if (result.result.image) {
                                imageUrl = result.result.image;
                            } else if (result.result.url) {
                                imageUrl = result.result.url;
                            }
                            
                            if (!imageUrl) {
                                throw new Error('No image URL found in response');
                            }
                            
                            console.log("Original Image URL:", imageUrl);
                            
                            // Store the original URL for reference
                            currentImageUrl = imageUrl;
                            
                            // Use our proxy server to bypass CORS
                            const proxiedUrl = `/proxy-image?url=${encodeURIComponent(imageUrl)}`;
                            console.log("Proxied Image URL:", proxiedUrl);
                            
                            // Display the image using the proxied URL
                            displayImage(proxiedUrl);
                            
                            toggleLoading(false);
                            showNotification('Image generated successfully!', 'success');
                            
                        } else if (result.status === 'Error') {
                            // Generation failed
                            toggleLoading(false);
                            showNotification(`Generation error: ${result.details || 'Unknown error'}`, 'error');
                        } else if (result.status === 'Content Moderated' || result.status === 'Request Moderated') {
                            // Content was moderated
                            toggleLoading(false);
                            showNotification('Content was moderated. Please adjust your prompt and try again.', 'error');
                        } else if (result.progress) {
                            // Still processing with progress
                            elements.loadingText.textContent = `Generating your image... ${Math.round(result.progress * 100)}%`;
                            setTimeout(checkResult, 1000);
                        } else {
                            // Still processing, no progress info
                            setTimeout(checkResult, 1000);
                        }
                    } catch (error) {
                        console.error('Error polling for result:', error);
                        toggleLoading(false);
                        showNotification(`Failed to get result: ${error.message}`, 'error');
                    }
                };
                
                // Start polling
                checkResult();
            }
            
            function displayImage(imageUrl) {
                console.log("Displaying image:", imageUrl);
                
                // Show image
                elements.previewImage.src = imageUrl;
                elements.previewImage.classList.remove('hidden');
                elements.generationPlaceholder.classList.add('hidden');
                
                // Show action buttons
                elements.copyParamsBtn.classList.remove('hidden');
                elements.downloadBtn.classList.remove('hidden');
                elements.copyImageBtn.classList.remove('hidden');
                
                // Add fallback in case the image doesn't load
                elements.previewImage.onerror = function() {
                    console.error("Failed to load image through proxy. Creating direct link instead.");
                    
                    // Create a fallback button
                    const fallbackButton = document.createElement('div');
                    fallbackButton.className = 'text-center mt-4';
                    fallbackButton.innerHTML = `
                        <p class="mb-2 text-sm text-gray-600">Unable to display image directly:</p>
                        <a href="${currentImageUrl}" target="_blank" class="px-3 py-1.5 bg-indigo-600 text-white rounded-md text-sm hover:bg-indigo-700">
                            Open Image in New Tab
                        </a>
                    `;
                    
                    // Hide the image
                    elements.previewImage.classList.add('hidden');
                    
                    // Remove any existing fallback
                    const existingFallback = elements.previewContainer.querySelector('.text-center.mt-4');
                    if (existingFallback) {
                        elements.previewContainer.removeChild(existingFallback);
                    }
                    
                    elements.previewContainer.appendChild(fallbackButton);
                };
            }
            
            function toggleLoading(isLoading) {
                if (isLoading) {
                    elements.loadingIndicator.classList.remove('hidden');
                    elements.generationPlaceholder.classList.add('hidden');
                    elements.previewImage.classList.add('hidden');
                    elements.generateBtn.disabled = true;
                    elements.generateBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    
                    // Hide action buttons
                    elements.copyParamsBtn.classList.add('hidden');
                    elements.downloadBtn.classList.add('hidden');
                    elements.copyImageBtn.classList.add('hidden');
                    
                    // Remove any fallback buttons
                    const fallbackButton = elements.previewContainer.querySelector('.text-center.mt-4');
                    if (fallbackButton) {
                        elements.previewContainer.removeChild(fallbackButton);
                    }
                } else {
                    elements.loadingIndicator.classList.add('hidden');
                    elements.generateBtn.disabled = false;
                    elements.generateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }
            
            function showNotification(message, type = 'error') {
                console.log(`Notification (${type}): ${message}`);
                
                const notification = elements.notification;
                const notificationMessage = elements.notificationMessage;
                const notificationIcon = elements.notificationIcon;
                
                // Set message
                notificationMessage.textContent = message;
                
                // Set color and icon based on type
                if (type === 'success') {
                    notification.classList.remove('bg-red-500', 'bg-yellow-500');
                    notification.classList.add('bg-green-500');
                    notificationIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />`;
                } else if (type === 'warning') {
                    notification.classList.remove('bg-red-500', 'bg-green-500');
                    notification.classList.add('bg-yellow-500');
                    notificationIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />`;
                } else {
                    notification.classList.remove('bg-green-500', 'bg-yellow-500');
                    notification.classList.add('bg-red-500');
                    notificationIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />`;
                }
                
                // Show notification
                notification.classList.remove('translate-y-20', 'opacity-0');
                
                // Hide after 5 seconds
                setTimeout(() => {
                    notification.classList.add('translate-y-20', 'opacity-0');
                }, 5000);
            }
            
            function openImage() {
                if (!currentImageUrl) {
                    showNotification('No image to open', 'error');
                    return;
                }
                
                console.log("Opening image in new tab:", currentImageUrl);
                window.open(currentImageUrl, '_blank');
                showNotification('Image opened in new tab!', 'success');
            }
            
            function copyImageUrl() {
                if (!currentImageUrl) {
                    showNotification('No image URL to copy', 'error');
                    return;
                }
                
                console.log("Copying image URL:", currentImageUrl);
                
                navigator.clipboard.writeText(currentImageUrl)
                    .then(() => {
                        showNotification('Image URL copied to clipboard!', 'success');
                    })
                    .catch(err => {
                        showNotification('Failed to copy URL: ' + err.message, 'error');
                    });
            }
            
            function copyParams() {
                if (Object.keys(currentParams).length === 0) {
                    showNotification('No parameters to copy', 'error');
                    return;
                }
                
                // Format params as JSON string with indentation
                const paramsString = JSON.stringify(currentParams, null, 2);
                console.log("Copying parameters:", paramsString);
                
                navigator.clipboard.writeText(paramsString)
                    .then(() => {
                        showNotification('Parameters copied to clipboard!', 'success');
                    })
                    .catch(err => {
                        showNotification('Failed to copy parameters: ' + err.message, 'error');
                    });
            }
        });
    </script>
</body>
</html>